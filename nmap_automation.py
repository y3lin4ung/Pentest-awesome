import os, re, sys, subprocess

# Get user input
ip_address = sys.argv[1]
host_name = sys.argv[2]

#ip_address = input("Please enter IP Address: ")
#host_name = input("Please enter Host Name: ")

dir = f"{host_name}_nmap_scan"
os.makedirs(dir, exist_ok=True)
os.chdir(dir)

# Banner
print("""
 _  _                     _       _                  _   _          
| \| |_ __  __ _ _ __    /_\ _  _| |_ ___ _ __  __ _| |_(_)___ _ _  
| .` | '  \/ _` | '_ \  / _ \ || |  _/ _ \ '  \/ _` |  _| / _ \ ' \ 
|_|\_|_|_|_\__,_| .__/_/_/ \_\_,_|\__\___/_|_|_\__,_|\__|_\___/_||_|
                |_| |___|                                           
By @yelinaungChris
""")
print(f"IP Adress: {ip_address}, Hostname: {host_name}\n")

# Define output filenames
portscan_file = f"{host_name}_port_scan_results.txt"
service_scan_file = f"{host_name}_service_scan.txt"

# Perform initial aggressive port scan
try:
    print(f"{ip_address} {host_name} Ports Scan Started")  # Use f-strings for formatting
    print("*********************************************")
    with open(portscan_file, "w") as file:
        subprocess.run(["sudo", "nmap", "-p-", "--min-rate=1000", "-T4", ip_address], stdout=file, check=True)
    print("\n" + ip_address + " " + host_name + " Port Scan Result")
    print("*********************************************")
    with open(portscan_file, "r") as file_read:  # Open for reading
        contents = file_read.read()
        open_ports = ",".join(re.findall(r"(\d+)/tcp", contents))
        print("Open Ports: "+ open_ports + "\n")
        print(file_read.read())  # Print scan results directly
except subprocess.CalledProcessError as e:
    print("nmap command failed with exit status:", e.returncode)
    print("Error output:", e.output)  # Access detailed error output

try:
    print(f"{ip_address} {host_name} Service Scan Started")  # Use f-strings for formatting
    print("*********************************************")
    with open(service_scan_file, "w") as file:
        subprocess.run(["sudo", "nmap", "-sV", "-sC", "-O", "-p", open_ports, ip_address], stdout=file, check=True)
    print("\n" + ip_address + " " + host_name + " Service Scan Result")
    print("*********************************************")
    with open(service_scan_file, "r") as file:  # Open for reading
        print(file.read())  # Print scan results directly
except subprocess.CalledProcessError as e:
    print("nmap command failed with exit status:", e.returncode)
    print("Error output:", e.output)  # Access detailed error output


print("Scan results saved to:")
print(f"- {portscan_file}")
print(f"- {service_scan_file}")
print("*******************************\n")

